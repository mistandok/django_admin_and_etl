# Укажите необходимую версию python
FROM python:3.11-slim

ENV APP_DIR /opt/app

# Выберите папку, в которой будут размещаться файлы проекта внутри контейнера
WORKDIR $APP_DIR

# Заведите необходимые переменные окружения
ENV ETL_SETTINGS_MODULE 'config.settings'
# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Скопируйте в контейнер файлы, которые редко меняются
COPY requirements.txt requirements.txt

# Установите зависимости
RUN  apt-get update \
     && apt-get -y install libpq-dev gcc \
     && apt-get install acl \
     && apt install -y netcat \
     && groupadd -r web \
     && useradd -d $APP_DIR -r -g web web \
     && chown web:web -R $APP_DIR \
     && mkdir $APP_DIR/etl_logs \
     && touch $APP_DIR/etl_logs/etl_process_log.log \
     && pip install --upgrade pip

RUN pip install -r requirements.txt

# Скопируйте всё оставшееся. Для ускорения сборки образа эту команду стоит разместить ближе к концу файла.
COPY . $APP_DIR

RUN chmod u+x $APP_DIR/start-etl.sh \
    && setfacl -m u:web:rwx $APP_DIR/etl_logs/etl_process_log.log


USER web

ENTRYPOINT ["/opt/app/start-etl.sh"]